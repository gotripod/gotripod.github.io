<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>The Go Tripod Blog</title>
        <meta name="viewport" content="width=device-width">

       <!-- CSS (Stylesheets)
        ================================================== -->
    
        <link rel="stylesheet" href="assets/css/style.css">
        <link rel="stylesheet" href="assets/css/font-awesome.css">
        
        <!-- Google Web Fonts
        ================================================== -->
        
        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald">
        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Cabin">
        
        <!-- Favicons
        ================================================== -->
       
        

    </head>
    <body>

        <div class="site">
          <div class="header">
            <nav id="header-navigation" class="sixteen columns" role="navigation">
            
              <ul id="navigation">
                  <li><a href="index.html#header-global" title="Home">Home</a></li>
                  <li><a href="index.html#introduction" title="About Us">About Us</a></li>
                  <li><a href="index.html#latest-work" title="Our Work">Our Work</a></li>
                  <li><a href="index.html#services" title="Our Services">Our Services</a></li>
                  <li><a href="index.html#meet-the-team" title="Meet the Team">Meet the team</a></li>
                <li><a href="#" title="Blog">Blog</a></li>
                  <li><a href="index.html#contact" title="Contact Us">Contact Us</a></li>
              </ul>
              
              <select name="dropdown" size="1" onChange="scrollTo(this.value)">
                  <option value="" selected="selected">Navigation</option>
                  <option value="index.html#header-global">Home</option>
                  <option value="index.html#introduction">About Us</option>
                  <option value="index.html#latest-work">Our Work</option> 
                  <option value="index.html#services">Our Services</option> 
                  <option value="index.html#meet-the-team">Meet the team</option>
                  <option value="#">Blog</option>
                  <option value="index.html#contact">Contact Us</option>
              </select>
              
			</nav><!-- end #header-navigation -->
          </div>
		
        <section id="blog">
          <div class="container" style="margin-bottom:30px;">
			
				<div class="icon-holder intro" style="margin:0 auto;">
					<i class="icon-book" style="color:#e47c14 !important;"></i>
				</div>
			
          <h2>Building a medium to large scale Flex App using Cairngorm (Part 4)</h2>
<p class="meta">10 Jun 2008</p>

<div class="post">
<p>In this final part on building a medium to large scale flex or Air app using Cairngorm, I will look at how I approach the service locator and use flex builders built in responder mechanism to handle service call responses.<br />
<a id="more"></a><a id="more-360"></a></p>

<h2>Services</h2>

<p>In <a href="http://www.gotripod.com/2008/06/06/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-1/">part 1</a> we created a ServiceLocator singleton using the same method as we did for our ModelLocator. We will use this in a minute when we register our Service with the ServiceLocator.</p>

<p>I like to create a proxy class for my services.</p>

<pre lang="actionscript" line="1">package uk.co.clockobj.cairngormdemo.controller.services
{
    import mx.rpc.AsyncToken;
    import mx.rpc.IResponder;
    import mx.rpc.remoting.RemoteObject;

    public class UserService
    {
        private var ro : RemoteObject;

        public function UserService()
        {
            ro = new RemoteObject();
            ro.destination = "userService";
        }

        public function logInUser( username : String, password : String, responder : IResponder) : void
        {
            var at : AsyncToken = ro.logInUser( username, password );
            at.addResponder( responder );
        }

    }
}</pre>

<p>In this example we want to call a destination method called logInUser() passing a username and password as parameters. Here I am using the RemoteObject class to work with a backend server such as <a href="http://www.adobe.com/products/livecycle/">LiveCycle</a>, <a href="http://opensource.adobe.com/wiki/display/blazeds/BlazeDS">BlazeDS</a>, <a href="http://www.exadel.com/web/portal/flamingo">Flamingo</a>, <a href="http://www.themidnightcoders.com/weborb/">WebOrb</a> etc, via AMF (Actionscript Message Format), but you can use this with HTTPService, WebService, etc.</p>

<p>Notice that along with the two parameters that our service call will need, I have added a responder of type IResponder. I am going to use the <a href="http://www.darronschall.com/weblog/archives/000234.cfm">method championed by Darron Schall</a> where we use Flex's built in responder and AsyncToken mechanism.</p>

<p>We need to now register this service on our ServiceLocator.</p>

<pre lang="actionscript" line="1">package uk.co.clockobj.cairngormdemo.controller
{
    import uk.co.clockobj.cairngormdemo.controller.services.ProductService;
    import uk.co.clockobj.cairngormdemo.controller.services.UserService;

    public class ServiceLocator
    {
        private static var _instance:ServiceLocator;

        public static function getInstance():ServiceLocator {
            if (_instance == null) {
                _instance = new ServiceLocator();
            }
            return _instance;
        }

        public function ServiceLocator()
        {
            if ( _instance != null )
            {
                throw( new Error( "Singleton class has already been instantiated" ) );
            } else
            {
                // Instantiate services here
                userService = new UserService();
                productService = new ProductService();
            }
        }

        public var userService : UserService;
        public var productService : ProductService;

    }
}</pre>

<h2>IResponder</h2>

<p>The IResponder interface that we used in our service enforces any class that implements it to provide a result( data : Object ) and fault( info : Object ) method. Due to the Asynchronous nature of Actionscript 3, the AsyncToken ensures the responder we provide handles that particular service call. Regular Event handlers to not offer this.</p>

<p>We are going to get all the commands we create (that make service calls) to implement this IResponder interface, in addition to the ICommand interface. We can then pass the command to the service as the responder for the service call:</p>

<p>So for a command that gets the ProductDTOs we used in <a href="http://www.gotripod.com/2008/06/08/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-2/">Part 2</a>, using for example a getProducts() method call on a productService destination.</p>

<p><em>Service:</em></p>

<pre lang="actionscript" line="1">package uk.co.clockobj.cairngormdemo.controller.services
{
    import mx.rpc.AsyncToken;
    import mx.rpc.IResponder;
    import mx.rpc.remoting.RemoteObject;

    public class ProductService
    {
        private var ro : RemoteObject;





        public function ProductService()
        {
            ro = new RemoteObject();
            ro.destination = "productService";
        }

        public function getProducts( responder : IResponder ) : void
        {
            var at : AsyncToken = ro.getProducts();
            at.addResponder( responder );
        }

    }
}</pre>

<p>(We register this with our ServiceLocator as we did for the UserService)</p>

<p><em>GetAllProductsCommand:</em></p>

<pre lang="actionscript" line="1">package uk.co.clockobj.cairngormdemo.controller.commands
{
    import com.adobe.cairngorm.commands.ICommand;
    import com.adobe.cairngorm.control.CairngormEvent;

    import mx.rpc.IResponder;
    import mx.rpc.events.ResultEvent;

    import uk.co.clockobj.cairngormdemo.controller.ServiceLocator;
    import uk.co.clockobj.cairngormdemo.model.ModelLocator;

    public class GetAllProductsCommand implements ICommand, IResponder
    {
        public function GetAllProductsCommand()
        {
        }

        public function execute(event:CairngormEvent):void
        {
            ServiceLocator.getInstance().productService.getProducts( this );
        }

        public function result(data:Object):void
        {
            ModelLocator.getInstance().product.dtos = ResultEvent( data ).result;
        }

        public function fault(info:Object):void
        {
            // Fault handler code
        }

    }
}</pre>

<p>Once this command is registered with our controller we can dispatch the relevant event form anywhere in our application to load all the products into our model.</p>

<p>Notice above how the command implements the IResponder interface and passes itself to the service to act as the responder for the service call. We then get to handle the service response and fault from within the command.</p>

<h2>Chaining Commands Together (Revisited)</h2>

<p>With this knowledge, we can return to our SequenceCommand example where we want to log a user in and then call the ChangeApplicationStateCommand to change the view state of Main.mxml to the logged in user state or logged in Admin state</p>

<pre lang="actionscript" line="1">package uk.co.clockobj.cairngormdemo.controller.commands
{
    import com.adobe.cairngorm.commands.SequenceCommand;
    import com.adobe.cairngorm.control.CairngormEvent;

    import mx.rpc.IResponder;
    import mx.rpc.events.ResultEvent;

    import uk.co.clockobj.cairngormdemo.controller.AppController;
    import uk.co.clockobj.cairngormdemo.controller.ServiceLocator;
    import uk.co.clockobj.cairngormdemo.controller.events.LoginEvent;
    import uk.co.clockobj.cairngormdemo.model.ModelLocator;
    import uk.co.clockobj.cairngormdemo.model.dto.UserDTO;
    import uk.co.clockobj.cairngormdemo.model.session.SessionModel;

    public class LogUserInCommand extends SequenceCommand implements IResponder
    {
        public function LogUserInCommand()
        {
            this.nextEvent = new CairngormEvent(AppController.CHANGE_APP_STATE);
        }

        override public function execute(event:CairngormEvent):void
        {
            var le : LoginEvent = LoginEvent( event );
            ServiceLocator.getInstance().userService.logInUser( le.username, le.password, this );
        }

        public function result(data:Object):void
        {
            ModelLocator.getInstance().session.userDTO = UserDTO( ResultEvent( data ).result );

            if ( ModelLocator.getInstance().session.loggedInUser.isAdmin )
            {
                this.nextEvent.data = SessionModel.APP_STATE_ADMIN;
            }
            else
            {
                this.nextEvent.data = SessionModel.APP_STATE_LOGGED_IN;
            }
            executeNextCommand();
        }

        public function fault(info:Object):void
        {
            // Fault handler code goes here
        }

    }
}</pre>

<p>To use Cairngorm's SequenceCommand feature, our command has to extend SequenceCommand. SequenceCommand already implements ICommand but this means we need to override the execute() method and we still need to implement IResponder as we want this class to handle the response from the userService.</p>

<p>In the commands constructor we set the SequenceCommands nextEvent property which takes the CairngormEvent you want to dispatch from this command. When you are ready you can dispatch the event using the SequenceCommand's executeNextCommand() method.</p>

<p>Our ChangeApplicationStateCommand looks for the state we want to change to in the data property of the CairngormEvent so we set the relevant one in the result handler and dispatch.</p>

<p>As I previously demonstrated for the Product model, I have implemented similar code to convert the UserDTO returned from the service to a User model item object. The User object has some business logic in it to identify whether the user is an Admin (which is not in the DTO).</p>

<p>As you can see although Cairngorm adds a fair bit of code, in the long run we have a more organised and consistently centralised configuration which makes it easier to maintain, test etc. <a href="http://www.gotripod.com/2008/06/06/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-1/">As I stated in Part 1</a> my method is not the documented way of using Cairngorm but has been adapted over use on several large projects to the solution that works best for us. I hope this series is useful to anyone starting out with Cairngorm and I do recommend you look at <a href="http://www.gotripod.com/2007/10/17/simplified-cairngorm-easy-mvc-for-adobe-flex/">EasyMVC</a> and alternatives to Cairngorm such as <a href="http://puremvc.org/">PureMVC</a> ( I have never used this but only because Cairngorm meets my needs ).</p>

<p>I have also attached the source files I used to write this article which i hope will help you see how everything hangs together.: <a href='http://www.gotripod.com/wp-content/uploads/2008/06/cairngormdemo.zip'>Cairngorm Demo Srource Files</a></p>

<h2>Contents:</h2>

<p><a href="http://www.gotripod.com/2008/06/06/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-1/">Part 1 - Setting up a project for Cairngorm</a><br />
<a href="http://www.gotripod.com/2008/06/08/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-2/">Part 2 - The Model</a><br />
<a href="http://www.gotripod.com/2008/06/10/building-a-medium-to-large-scale-flex-app-using-cairngorm-part-3/">Part 3 - Commands</a><br />
Part 4 - Services<br />
<a href="http://www.gotripod.com/wp-content/uploads/2008/06/cairngormdemo.zip">Cairngorm Demo Source Files</a></p>

</div>

			
          </div>
          </section>
			
          <footer id="footer-global" role="contentinfo" class="clearfix">
	
		<section id="contact">
		
			<div class="container">
			
				<div class="row">
		
					<div class="sixteen columns">
					
						<div class="icon-holder contact">
							<i class="icon-envelope"></i>
						</div>
						
						<h1>Got a great idea? Lets talk.</h1>
						
						<p>Please get in touch with us, we promise we won't bite!</p>
					
						<address id="contact-details">
						
							<p><a href="mailto:hello@gotripod.com?Subject=Ok, don't bite me! But I would like to talk about ...">hello@gotripod.com</a> // <a href="tel:08454752487">0845 475 2487</a><br />
							Tremough Innovation Centre, Penryn Campus
							<br>
							 Penryn, Cornwall, UK, TR10 9TA</p>
						
						</address>
                        
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d40886.830442687766!2d-5.127996999999958!3d50.17185400000002!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x486b16307846c97b%3A0x6b783d3b216b6f4d!2sGo+Tripod+Ltd!5e0!3m2!1sen!2s!4v1398110943195" width="100%" height="300" frameborder="0" style="border:0"></iframe>
                    
					</div>		
					
				</div><!-- end .row -->
			
				<div class="row">
				
					<div class="sixteen columns">
					
						<ul class="social-icons footer">
						
							<li><a href="http://www.twitter.com/gotripod" target="_blank" title="go Tripod on Twitter"><img src="assets/img/social-icons/twitter_icon_small.png" width="32" height="32" alt="" /></a></li>
							<li><a href="http://www.facebook.com/gotripod" target="_blank" title="go Tripod on Facebook"><img src="assets/img/social-icons/facebook_icon_small.png" width="32" height="32" alt="" /></a></li>
							<li><a href="http://www.linkedin.com/company/go-tripod-ltd" target="_blank" title="Go Tripod on LinkedIn"><img src="assets/img/social-icons/linkedin_icon_small.png" width="32" height="32" alt="" /></a></li>
							<li><a href="https://plus.google.com/u/0/b/101897321380998049253/101897321380998049253/posts" target="_blank" title="go Tripod on Google +"><img src="assets/img/social-icons/google_plus_icon_small.png" width="32" height="32" alt="" /></a></li>
							
						</ul>
						
					</div>
					
				</div><!-- end .row -->
		
				<div class="row">
		
					<div class="sixteen columns">
				  	  
			  			<p id="copyright-details">&copy; 2014	 Go Tripod.<br>Registered in the UK company number 6912029 VAT No. 972 5228 06</p>
             		
			  		</div>
			  		
			  	</div><!-- end .row -->	  
		  	
			</div><!-- end .container -->
		
		</section><!-- end #contact -->
		
	</footer><!-- end #footer-global -->

    </body>
</html>
